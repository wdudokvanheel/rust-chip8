<!DOCTYPE html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
	<style>
		html, body {
			margin: 0px;
			padding: 0px;
			width: 100%;
			height: 100%;
			background: #1d1d1d;
			padding: env(safe-area-inset);
		}

		canvas {
			display: block;
			padding: 0px;
			margin: 0px;
			width: 90%;
			aspect-ratio: 2/1;
			outline: none;
		}
	</style>

	<script type="module">
		import {default as init, WasmRuntime} from './chip8.js';

		const canvas = document.getElementById("canvas");

		let runtime = undefined;
		let callback = undefined;
		let roms = [];

		function reset() {
			if(callback != undefined) {
				callback.reset();
			}
		}

		function load_rom(id) {
			if(callback != undefined) {
				callback.load_rom(id);
			}
		}

		async function start() {
			await init('./chip8_bg.wasm');
			return new WasmRuntime();
		}

		start().then(value => {
			runtime = value
			callback = runtime.get_sender();
			roms = runtime.get_roms();
			create_rom_list();
			runtime.start();
		});

		canvas.addEventListener('contextmenu', function (e) {
			e.preventDefault();
		});

		document.addEventListener("DOMContentLoaded", function () {
			const resetButton = document.getElementById("reset");
			resetButton.addEventListener("click", reset);

			const romButtons = document.getElementsByClassName("loadrom");
			for (const button of romButtons) {
				button.addEventListener("click", function (event) {
					const romId = event.currentTarget.getAttribute('data-rom-id');
					load_rom(Number(romId));
				});
			}
		});

		function create_rom_list() {
			const romButtonsContainer = document.querySelector('.rombuttons');
			romButtonsContainer.innerHTML = '';

			roms.forEach((rom, index) => {
				const romButtonDiv = document.createElement('div');
				const romButton = document.createElement('button');
				romButton.className = 'loadrom bg-blue-500 hover:bg-blue-700 rounded p-2 w-full';
				romButton.textContent = rom;
				romButton.setAttribute('data-rom-id', index);
				romButton.addEventListener("click", function (event) {
					const romId = event.currentTarget.getAttribute('data-rom-id');
					load_rom(Number(romId));
				});
				romButtonDiv.appendChild(romButton);
				romButtonsContainer.appendChild(romButtonDiv);
			});
		}
	</script>
</head>
<body>
	<div class="flex flex-col space-y-2 p-2">
		<div class="mx-auto">
			<button id="reset" class="text-white bg-red-500 hover:bg-red-700 font-bold rounded px-4 py-2">
				Reset device
			</button>
		</div>

		<div class="w-full">
			<canvas id="canvas" class="mx-auto"></canvas>
		</div>
		<h1 class="mx-auto text-white font-xl">Select ROM</h1>
		<div class="rombuttons grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 xlg:grid-cols-10 gap-2">

		</div>
	</div>
</body>
<html>
